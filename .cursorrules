## Project Structure (Current Implementation)

```
src/
â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/            # Authentication routes
â”‚   â”‚   â”œâ”€â”€ login/page.tsx # Login page with shadcn/ui
â”‚   â”‚   â”œâ”€â”€ register/page.tsx # Registration page with two-tier system
â”‚   â”‚   â””â”€â”€ invite/[id]/page.tsx # Invitation acceptance page
â”‚   â”œâ”€â”€ (dashboard)/       # Dashboard routes
â”‚   â”‚   â””â”€â”€ [env]/         # Partner-specific routes
â”‚   â”‚       â”œâ”€â”€ layout.tsx # Dashboard layout with sidebar
â”‚   â”‚       â”œâ”€â”€ page.tsx   # Dashboard overview
â”‚   â”‚       â”œâ”€â”€ products/  # Product management
â”‚   â”‚       â”œâ”€â”€ locations/ # Location management
â”‚   â”‚       â”œâ”€â”€ members/   # Member management
â”‚   â”‚       â”œâ”€â”€ analytics/ # Analytics dashboard
â”‚   â”‚       â””â”€â”€ settings/  # Partner settings
â”‚   â”œâ”€â”€ admin/             # Admin routes
â”‚   â”‚   â”œâ”€â”€ layout.tsx     # Admin layout
â”‚   â”‚   â”œâ”€â”€ page.tsx       # Admin dashboard
â”‚   â”‚   â””â”€â”€ environments/page.tsx # Partner management
â”‚   â”œâ”€â”€ api/               # API routes
â”‚   â”‚   â”œâ”€â”€ email/send/route.ts # Email sending
â”‚   â”‚   â”œâ”€â”€ environments/[slug]/route.ts # Partner API
â”‚   â”‚   â””â”€â”€ locations/[id]/route.ts # Location API
â”‚   â”œâ”€â”€ auth/callback/route.ts # Auth callback
â”‚   â”œâ”€â”€ dashboard/page.tsx # Dashboard redirect
â”‚   â”œâ”€â”€ layout.tsx         # Root layout
â”‚   â”œâ”€â”€ page.tsx           # Home page (redirects to login)
â”‚   â””â”€â”€ globals.css        # Global styles with CSS variables
â”œâ”€â”€ components/            # React components
â”‚   â”œâ”€â”€ ui/               # shadcn/ui components (generated)
â”‚   â”œâ”€â”€ dashboard/        # Dashboard-specific components
â”‚   â”‚   â”œâ”€â”€ environment-switcher.tsx # Partner switcher with Command/Popover
â”‚   â”‚   â””â”€â”€ page-breadcrumb.tsx # Page breadcrumbs
â”‚   â”œâ”€â”€ data-table/       # Table components with filtering/sorting
â”‚   â”œâ”€â”€ product/          # Product-specific components
â”‚   â”‚   â”œâ”€â”€ product-dialog.tsx # Product creation/editing
â”‚   â”‚   â”œâ”€â”€ product-detail-dialog.tsx # Product details
â”‚   â”‚   â”œâ”€â”€ products-table-wrapper.tsx # Products table
â”‚   â”‚   â”œâ”€â”€ import-products-dialog.tsx # CSV import
â”‚   â”‚   â””â”€â”€ category-selector.tsx # Category selection
â”‚   â”œâ”€â”€ location/         # Location components
â”‚   â”‚   â”œâ”€â”€ location-dialog.tsx # Location creation/editing
â”‚   â”‚   â””â”€â”€ location-card.tsx # Location display
â”‚   â”œâ”€â”€ members/          # Member management
â”‚   â”‚   â”œâ”€â”€ invite-member-dialog.tsx # Member invitations
â”‚   â”‚   â””â”€â”€ members-data-table.tsx # Members table
â”‚   â”œâ”€â”€ settings/         # Settings components
â”‚   â”‚   â””â”€â”€ settings-form.tsx # User settings
â”‚   â”œâ”€â”€ auth/             # Authentication components
â”‚   â”‚   â””â”€â”€ accept-invite-form.tsx # Invitation acceptance
â”‚   â”œâ”€â”€ email/            # Email components
â”‚   â”‚   â””â”€â”€ test-email-button.tsx # Email testing
â”‚   â”œâ”€â”€ app-sidebar.tsx   # Main sidebar component
â”‚   â”œâ”€â”€ login-form.tsx    # Login form
â”‚   â”œâ”€â”€ register-form.tsx # Registration form with two-tier system
â”‚   â””â”€â”€ logout-button.tsx # Logout button
â”œâ”€â”€ lib/                  # Utility libraries
â”‚   â”œâ”€â”€ supabase/         # Supabase clients and auth
â”‚   â”‚   â”œâ”€â”€ client-browser.ts # Browser client
â”‚   â”‚   â”œâ”€â”€ client-server.ts  # Server client (fixed cookie handling)
â”‚   â”‚   â””â”€â”€ auth.ts       # Authentication utilities
â”‚   â”œâ”€â”€ db/               # Database operations
â”‚   â”‚   â”œâ”€â”€ environments/ # Partner operations
â”‚   â”‚   â”‚   â”œâ”€â”€ get-environments.ts # Get partners for user/by slug
â”‚   â”‚   â”‚   â”œâ”€â”€ create-environment.ts # Create new partner
â”‚   â”‚   â”‚   â”œâ”€â”€ update-environment.ts # Update partner
â”‚   â”‚   â”‚   â””â”€â”€ get-user-environments.ts # Get user's partners
â”‚   â”‚   â”œâ”€â”€ products/     # Product operations
â”‚   â”‚   â”‚   â”œâ”€â”€ get-products.ts # Get products for partner
â”‚   â”‚   â”‚   â”œâ”€â”€ create-product.ts # Create new product
â”‚   â”‚   â”‚   â”œâ”€â”€ update-product.ts # Update product
â”‚   â”‚   â”‚   â”œâ”€â”€ delete-product.ts # Delete product
â”‚   â”‚   â”‚   â”œâ”€â”€ import-products.ts # CSV import
â”‚   â”‚   â”‚   â”œâ”€â”€ bulk-actions.ts # Bulk operations
â”‚   â”‚   â”‚   â””â”€â”€ get-dashboard-stats.ts # Dashboard statistics
â”‚   â”‚   â”œâ”€â”€ locations/    # Location operations
â”‚   â”‚   â”‚   â”œâ”€â”€ get-locations.ts # Get locations for partner
â”‚   â”‚   â”‚   â”œâ”€â”€ create-location.ts # Create new location
â”‚   â”‚   â”‚   â””â”€â”€ get-location-stats.ts # Location statistics
â”‚   â”‚   â”œâ”€â”€ profiles/     # Profile operations
â”‚   â”‚   â”‚   â”œâ”€â”€ get-profile.ts # Get user profile
â”‚   â”‚   â”‚   â””â”€â”€ update-profile.ts # Update profile
â”‚   â”‚   â””â”€â”€ members/      # Member operations
â”‚   â”‚       â”œâ”€â”€ invite-member.ts # Invite new member
â”‚   â”‚       â”œâ”€â”€ get-members.ts # Get partner members
â”‚   â”‚       â””â”€â”€ accept-invite.ts # Accept invitation
â”‚   â”œâ”€â”€ email/            # Email functionality
â”‚   â”‚   â”œâ”€â”€ email-service.ts # Email sending service
â”‚   â”‚   â”œâ”€â”€ email-templates.ts # Email templates
â”‚   â”‚   â”œâ”€â”€ email-config.ts # Email configuration
â”‚   â”‚   â””â”€â”€ email-actions.ts # Email server actions
â”‚   â””â”€â”€ utils/            # Utility functions
â”‚       â”œâ”€â”€ cn.ts         # Class name utility
â”‚       â”œâ”€â”€ rbac.ts       # Role-based access control
â”‚       â”œâ”€â”€ urls.ts       # URL builders
â”‚       â”œâ”€â”€ categories.ts # Product categories
â”‚       â”œâ”€â”€ email-templates.ts # Email template helpers
â”‚       â””â”€â”€ zod-schemas/  # Validation schemas
â”‚           â”œâ”€â”€ product.ts
â”‚           â”œâ”€â”€ environment.ts
â”‚           â””â”€â”€ invite.ts
â”œâ”€â”€ hooks/                # Custom React hooks
â”‚   â”œâ”€â”€ use-toast.ts      # Toast notifications
â”‚   â”œâ”€â”€ use-email.ts      # Email functionality
â”‚   â””â”€â”€ use-mobile.tsx    # Mobile detection
â”œâ”€â”€ middleware.ts         # Next.js middleware for auth
â””â”€â”€ types/                # TypeScript type definitions
    â””â”€â”€ db.ts             # Database types and enums
```

---

## Database Schema (Production Ready)

### Core Tables

- `profiles` - User profiles with authentication, account types, and business_id for multi-tenant access
- `partners` - Multi-tenant partners with logo support
- `memberships` - User-partner relationships with roles
- `locations` - Physical locations within partners
- `products` - Product inventory with full metadata
- `product_status_history` - Status change tracking
- `product_comments` - Product discussions
- `product_images` - Product image metadata
- `sales` - Sales records
- `partner_invites` - User invitations with expiration
- `invite_codes` - Partner invite codes with usage tracking

### Multi-Tenant Structure

- `profiles.business_id` - Links users to their business (NULL for platform admins)
- `profiles.is_partner_admin` - TRUE for business owners, FALSE for platform admins
- `profiles.primary_partner_id` - Business owner's partner ID (NULL for platform admins)

### Enums

- `role`: admin, store_manager (Partner Managers only)
- `product_status`: taken, in_repair, selling, sold, returned, discarded

### Database Functions & Triggers

- `handle_new_user_registration()` - Creates profiles, partners, and memberships with business_id
- `on_new_user_registration` - Trigger for new user registration
- `enforce_environment_ownership_trigger` - Protects partner ownership

### RLS Policies

- All tables have Row Level Security enabled
- Multi-tenant data access control based on business_id
- Role-based permissions
- Secure invitation system
- Business owners and partners can see each other's data within same business

---

## Current Working Features

### âœ… Authentication & Authorization

- Complete Supabase Auth integration with two-tier registration
- Role-based access control (RBAC)
- Secure session management
- Multi-tenant data access control
- Invitation system with email notifications

### âœ… Multi-Tenant Partner System

- Partner-based routing with `[env]` parameter
- Multi-tenant data isolation between businesses
- Collaborative access within same business
- Partner switcher with logos and keyboard shortcuts
- Business owner partner creation with logo upload
- User invitation and membership management

### âœ… Registration System

- **Two-Tier Registration**: Business Owner and Platform Admin account types
- **Business Owner Registration**: Creates own business dashboard
- **Platform Admin Registration**: Gets system admin access
- **Database Triggers**: Automatic profile, partner, and membership creation with business_id
- **UI Clarity**: Clear labeling for business owners vs platform admins

### âœ… Multi-Tenant Collaboration

- **Business Owners**: Can see all data from partners in their business
- **Partners**: Can see all data from business owner and other partners in same business
- **Data Isolation**: Complete isolation between different businesses
- **Platform Admins**: Can see all data across all businesses
- **Business_ID**: Links users to their business for multi-tenant access

### âœ… Dashboard & Navigation

- Partner-specific dashboard layouts
- Sidebar navigation with partner switcher and logos
- SPA-style navigation (no full page reloads)
- Active route highlighting
- Breadcrumb navigation
- Mobile-responsive design with bottom navigation

### âœ… Product Management

- Complete CRUD operations for products
- Product status tracking with history
- Category system with hierarchical organization
- CSV import with validation and error handling
- Bulk operations (status updates, deletion)
- Product search and filtering
- Image upload support (schema ready)
- Action buttons integrated into table toolbar
- Multi-tenant access: users can see products from all users in same business

### âœ… Location Management

- Location CRUD operations
- Location-specific product tracking
- Contact information management
- Location statistics and analytics
- Responsive grid layout
- Multi-tenant access: users can see locations from all users in same business

### âœ… Member Management

- User invitation system with invite codes
- Role assignment and management
- Member activity tracking
- Partner access control
- Action buttons integrated into table toolbar
- Multi-tenant access: users can see members from same business

### âœ… Analytics & Reporting

- Dashboard statistics and metrics
- Product status distribution
- Revenue tracking
- Time-to-sale analytics
- Location-based reporting
- Modern bar charts and visualizations
- Multi-tenant data aggregation

### âœ… Settings & Configuration

- User profile management
- Partner settings
- Notification preferences
- Security settings

### âœ… Theme System

- Complete dark/light mode implementation
- Theme-aware CSS variables
- Consistent theming across all components
- Theme toggle in sidebar and mobile menu

---

## Development Guidelines

### Code Style

- Follow Standard.js rules (2 spaces, no semicolons, camelCase)
- Use functional components with hooks
- Prefer server components over client components
- Use TypeScript for type safety
- Follow the established file structure

### Navigation Rules

- Use `import Link from "next/link"` for all navigation
- Use `const router = useRouter(); router.push(url)` for programmatic navigation
- All routes render inside the dashboard layout - no full refresh
- Sidebar items use Link and highlight active routes
- Partner-based routing: `/[env]/[section]`

### UI Rules

- Use shadcn/ui components only - no native HTML styling
- Import from `@/components/ui/[component]`
- Use Tailwind CSS for styling
- Follow shadcn/ui design patterns
- Ensure mobile responsiveness
- Use theme-aware CSS variables (`bg-popover`, `text-popover-foreground`, etc.)

### Table Component Rules

- **Action Buttons**: Place action buttons (Add Product, Invite Users, etc.) in the table toolbar alongside filter and view options, not as separate buttons near page headings
- **DataTable Props**: Use `actionButtons` prop to pass custom buttons to table toolbar
- **Filter Placeholders**: Use `filterPlaceholder` prop for context-appropriate filtering (e.g., "Filter products...", "Filter members...")
- **Mobile Layout**: Use `space-y-4` instead of `flex items-center justify-between` for page headers to ensure proper mobile stacking
- **Row Selection**: Disabled by default (`enableRowSelection: false`) - only enable when bulk actions are needed
- **Default Page Size**: Set to 10 rows (`initialState: { pagination: { pageSize: 10 } }`)
- **Pagination Display**: Show "X total row(s)" instead of selection count, hide "Rows per page" selector

### Data Fetching

- Use React Server Components for data fetching where possible
- Use server actions for mutations
- Implement proper error handling
- Use revalidatePath/router.refresh() after mutations
- Multi-tenant data access based on business_id

### Security Rules

- All routes require authentication
- Multi-tenant data access control based on business_id
- Role-based permissions
- Input validation with Zod schemas
- Secure API endpoints with RLS

---

## Production Setup

### 1. Environment Variables

```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Email Configuration (Resend)
RESEND_API_KEY=your_resend_api_key
EMAIL_FROM_ADDRESS=noreply@your-domain.com
NEXT_PUBLIC_APP_URL=https://your-domain.com

# Optional: Debug Configuration
DEBUG_EMAILS=false
```

### 2. Database Setup

```bash
# Run all migrations in order
supabase/migrations/001_initial_schema.sql
supabase/migrations/002_create_storage_bucket.sql
supabase/migrations/003_rename_environments_to_partners.sql
supabase/migrations/004_fix_storage_policies.sql
supabase/migrations/005_enable_user_registration.sql
supabase/migrations/006_fix_account_type_logic.sql
supabase/migrations/007_swap_account_type_logic.sql
supabase/migrations/008_update_rls_for_multi_tenant.sql
supabase/migrations/009_update_trigger_for_business_id.sql
```

### 3. Admin User Creation

```bash
node scripts/create-admin-user.js
```

### 4. Partner Creation

- Use business owner dashboard to create production partners
- Invite team members with appropriate roles
- Configure partner settings

---

## Testing the Implementation

### Start Development Server

```bash
npm run dev
```

### Test Routes

- **Login**: http://localhost:3000/login
- **Registration**: http://localhost:3000/register
- **Admin Dashboard**: http://localhost:3000/admin
- **Partner Dashboard**: http://localhost:3000/[env]
- **Products**: http://localhost:3000/[env]/products
- **Locations**: http://localhost:3000/[env]/locations
- **Members**: http://localhost:3000/[env]/members
- **Analytics**: http://localhost:3000/[env]/analytics
- **Settings**: http://localhost:3000/[env]/settings

### Testing the Registration System

1. **Business Owner Registration**:
   - Go to `/register`
   - Select "Business Owner" account type
   - Fill in company name and personal details
   - Verify account creation and business dashboard setup

2. **Platform Admin Registration**:
   - Go to `/register`
   - Select "Platform Admin" account type
   - Fill in company name and personal details
   - Verify account creation and admin dashboard access

3. **Partner Registration**:
   - Generate invite code from business owner dashboard
   - Share invite code or direct link
   - Test partner registration with invite code
   - Verify partner activation and business access

4. **Multi-Tenant Testing**:
   - Create multiple business owners
   - Invite partners to different businesses
   - Verify data isolation between businesses
   - Test collaborative access within same business

### Current Working Features

- âœ… Complete authentication system with two-tier registration
- âœ… Multi-tenant partner management with logo support
- âœ… Multi-tenant collaboration: business owners and partners can see each other's data
- âœ… Product management with CSV import and status tracking
- âœ… Location management with responsive grid layout
- âœ… Member management with invite codes system
- âœ… Analytics and reporting with modern charts
- âœ… Settings and configuration
- âœ… Mobile-responsive design with bottom navigation
- âœ… Complete theme system (dark/light mode)
- âœ… TypeScript compilation
- âœ… All components working
- âœ… Partner logo support and display
- âœ… Invite codes management and tracking
- âœ… Partner activation flow
- âœ… Email system with Resend integration
- âœ… Database triggers and functions working correctly
- âœ… Multi-tenant RLS policies implemented

---

## Acceptance Criteria Status

1. âœ… **Authentication**: Complete Supabase Auth integration with two-tier registration
2. âœ… **Multi-Tenancy**: Multi-tenant data isolation with collaborative access within businesses
3. âœ… **Navigation**: All navigation uses Next.js routing
4. âœ… **UI Components**: Every component uses shadcn/ui
5. âœ… **RLS**: Multi-tenant row-level security implemented
6. âœ… **Product Management**: Complete CRUD with status tracking
7. âœ… **CSV Import**: Bulk import with validation
8. âœ… **Member Management**: Invitation system with invite codes
9. âœ… **Analytics**: Dashboard statistics and reporting with charts
10. âœ… **Security**: Comprehensive security measures
11. âœ… **Theme System**: Complete dark/light mode implementation
12. âœ… **Mobile Responsiveness**: Bottom navigation and responsive layouts
13. âœ… **Invite Codes**: Complete invite code system with usage tracking
14. âœ… **Partner Activation**: Secure partner activation flow
15. âœ… **Email System**: Email notifications and invitations
16. âœ… **Multi-Tenant Collaboration**: Business owners and partners can see each other's data

---

## File Updates Made

### Recently Completed

- âœ… Removed all demo content and functionality
- âœ… Updated all database functions for production use
- âœ… Implemented complete authentication system with two-tier registration
- âœ… Added partner-based access control with logo support
- âœ… Updated all components for real data
- âœ… Implemented invitation system with invite codes
- âœ… Added email functionality with Resend integration
- âœ… Updated documentation for production
- âœ… Integrated action buttons into table toolbars
- âœ… Improved mobile responsiveness and table display
- âœ… Added partner logo support in sidebar and switcher
- âœ… Implemented complete theme system with dark/light mode
- âœ… Added mobile bottom navigation and responsive layouts
- âœ… Fixed dialog backgrounds to use theme-aware styling
- âœ… Updated stats grids for mobile responsiveness
- âœ… Added modern bar charts for analytics
- âœ… Improved location management with responsive grid layout
- âœ… Implemented invite codes system with usage tracking
- âœ… Added partner activation flow
- âœ… Created invite codes management interface
- âœ… Updated registration form with step-by-step flow
- âœ… Added URL parameter support for invite codes
- âœ… Fixed database trigger issues for user registration
- âœ… Updated registration form UI text for clarity
- âœ… Resolved "created_by cannot be modified" database errors
- âœ… Implemented multi-tenant RLS policies
- âœ… Added business_id column for multi-tenant access
- âœ… Updated account types: Business Owner vs Platform Admin
- âœ… Implemented collaborative data access within businesses

### Current Working Files

- All TypeScript files compile without errors
- All components render correctly
- Navigation works as expected
- Database operations work with real data
- Email system functional with Resend
- Security measures implemented
- Theme system fully functional
- Mobile responsiveness complete
- Invite codes system fully operational
- Partner activation flow working
- Registration system with two-tier accounts working
- Database triggers and functions working correctly
- Multi-tenant RLS policies working correctly
- Business owners and partners can see each other's data
- Complete data isolation between different businesses

---

**Status**: ðŸŸ¢ **PRODUCTION READY**

The application is now production-ready with complete multi-tenant functionality, proper authentication with two-tier registration system, comprehensive security measures, full theme system, mobile-responsive design, complete invite codes system, and multi-tenant collaboration features. All demo content has been removed and the system works exclusively with real partners and user data.
